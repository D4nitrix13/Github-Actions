name: PostgreSQL Integration Test (Using GitHub Secrets)

on:
  workflow_dispatch:

jobs:
  postgres-secrets-connection:
    name: Connect to PostgreSQL Using Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Show Docker version (debug)
        run: docker version

      - name: Start PostgreSQL using Docker and Secrets
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        run: |
          docker run -d \
            --name ci-postgres \
            -e POSTGRES_USER="$POSTGRES_USER" \
            -e POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
            -e POSTGRES_DB="$POSTGRES_DB" \
            -p 5432:5432 \
            postgres:latest

      - name: Wait for PostgreSQL to be ready
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
        run: |
          for i in {1..30}; do
            if docker exec ci-postgres pg_isready -U "$POSTGRES_USER" > /dev/null 2>&1; then
              echo "PostgreSQL is ready"
              exit 0
            fi
            echo "Waiting for PostgreSQL to be ready... ($i)"
            sleep 2
          done

          echo "PostgreSQL did not become ready in time"
          docker logs ci-postgres
          exit 1

      - name: Install PostgreSQL Client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Test Connection Using Secrets
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        run: |
          psql \
            -h localhost \
            -U "$POSTGRES_USER" \
            -d "$POSTGRES_DB" \
            -c "SELECT now();"

      - name: Cleanup container
        if: always()
        run: |
          docker ps -a
          docker rm -f ci-postgres || true
